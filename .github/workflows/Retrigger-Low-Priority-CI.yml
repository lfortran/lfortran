name: Retrigger low-priority PRs

on:
  schedule:
    - cron: '17 * * * *'

jobs:
  retrigger:
    runs-on: ubuntu-latest
    steps:
      - name: Retrigger one low-priority PR if queue is idle
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO="${{ github.repository }}"

          active=$(gh api "repos/$REPO/actions/workflows/Quick-Checks-CI.yml/runs" \
            --jq '[.workflow_runs[] | select(.status=="in_progress" or .status=="queued")] | length')

          if [ "$active" -gt 0 ]; then
            echo "Queue busy ($active Quick Checks runs active), skipping"
            exit 0
          fi

          pr=$(gh pr list --repo "$REPO" --label "Tests::Run-When-Idle" --state open \
            --json number --jq '.[0].number // empty')

          if [ -z "$pr" ]; then
            echo "No low-priority PRs pending"
            exit 0
          fi

          echo "Removing 'Tests::Run-When-Idle' label from PR #$pr to trigger CI"
          gh pr edit "$pr" --repo "$REPO" --remove-label "Tests::Run-When-Idle"
